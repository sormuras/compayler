<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<project basedir="." name="Compayler" default="test">

	<tstamp>
		<format property="timestamp" pattern="yyyyMMddHHmm" />
	</tstamp>

	<property name="dir.out" value="bin/ant" />

	<path id="compile.class.path">
		<pathelement path="lib/prevayler-core-2.6.jar" />
	</path>

	<target name="clean">
		<delete dir="${dir.out}" />
	</target>

	<target name="init" depends="clean">
		<echo>be*free</echo>
		<mkdir dir="${dir.out}" />
	</target>

	<target name="compile" depends="init">
		<mkdir dir="${dir.out}/classes" />
		<javac destdir="${dir.out}/classes" debug="no" deprecation="no" optimize="yes" encoding="UTF-8" includeantruntime="no">
			<classpath refid="compile.class.path" />
			<src path="src/core" />
		</javac>
		<jar destfile="${dir.out}/compayler.jar">
			<fileset dir="${dir.out}/classes">
				<!-- <exclude name="org/prevayler/contrib/compayler/javac/**/*" /> -->
			</fileset>
			<!-- 
			<manifest>
				<attribute name="Main-Class" value="org.prevayler.contrib.compayler.Compayler" />
			</manifest>
			 -->
			<service type="javax.annotation.processing.Processor">
				<provider classname="org.prevayler.contrib.compayler.Processor" />
			</service>
		</jar>
	</target>

	<target name="test" depends="compile" description="execute all tests">
		<path id="junit.class.path">
			<pathelement path="src/test" />
			<pathelement path="${dir.out}/compayler.jar" />
			<pathelement path="${dir.out}/junit/classes" />
			<path refid="compile.class.path" />
			<pathelement path="lib/junit-4.11.jar" />
			<pathelement path="lib/hamcrest-core-1.3.jar" />
		</path>

		<!--
		<java classname="org.prevayler.contrib.compayler.Compayler" fork="yes">
			<classpath>
				<pathelement path="${dir.out}/compayler.jar" />
			</classpath>
			<arg value="src/generated" />
			<arg value="java.lang.Appendable" />
			<arg value="java.lang.CharSequence" />
			<arg value="http://grepcode.com/file_/repository.grepcode.com/java/root/jdk/openjdk/7-b147/java/lang/Comparable.java/?v=source" />
		</java>
		-->

		<mkdir dir="${dir.out}/junit/classes" />
		<mkdir dir="${dir.out}/junit/reports" />
		<javac destdir="${dir.out}/junit/classes" encoding="UTF-8" includeantruntime="no">
			<classpath refid="junit.class.path" />
			<src path="src/test" />
			<src path="src/generated" />
		</javac>

		<junit printsummary="yes" fork="yes" haltonfailure="no">
			<sysproperty key="junit.running" value="${ant.version}" />
			<classpath refid="junit.class.path" />
			<formatter type="plain" />
			<batchtest todir="${dir.out}/junit/reports">
				<fileset dir="src/test">
					<include name="**/*Test.java" />
					<exclude name="**/AllTests.java" />
				</fileset>
			</batchtest>
		</junit>
	</target>

</project>
